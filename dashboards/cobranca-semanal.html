<!DOCTYPE html>
<html>
<head>
  <title>Cobran√ßa Semanal | Ger.Comercial</title>
  <script src="https://cdn.jsdelivr.net/npm/@libsql/client@0.5.6/lib-cdn.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; margin: 20px; background: #f5f5f5; }
    .filtros-container {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 4px;
      margin: 10px 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      align-items: end;
    }
    .filtro-grupo {
      display: flex;
      flex-direction: column;
    }
    .filtro-grupo label {
      font-weight: bold;
      margin-bottom: 5px;
      font-size: 14px;
    }
    select {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      border: 1px solid #bbb;
      border-radius: 4px;
    }
    .btn-atualizar {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      align-self: end;
    }
    .btn-atualizar:hover {
      background: #1565c0;
    }
    .card { background: white; border-left: 5px solid #333; padding: 15px; margin: 10px 0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .critico { border-left-color: #d32f2f; background: #ffebee; }
    .atencao { border-left-color: #f57c00; background: #fff3e0; }
    .excelente { border-left-color: #388e3c; background: #e8f5e8; }
    .metrica { display: inline-block; width: 220px; margin: 5px; vertical-align: top; }
    .barra { height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; }
    .barra-preenchida { height: 100%; background: #4caf50; transition: width 0.3s; }
    .valor { font-size: 24px; font-weight: bold; color: #333; }
    .label { font-size: 12px; color: #666; }
    .header { background: #1976d2; color: white; padding: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>üéØ Dashboard de Cobran√ßa Semanal</h1>

  <div class="filtros-container">
    <div class="filtro-grupo">
      <label for="semanaSelect">üìÖ Semana:</label>
      <select id="semanaSelect">
        <option value="">Carregando...</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <label for="supervisorSelect">üëî Supervisor:</label>
      <select id="supervisorSelect" onchange="filtrarRepresentantes()">
        <option value="">Todos</option>
      </select>
    </div>

    <div class="filtro-grupo">
      <label for="representanteSelect">üë§ Representante:</label>
      <select id="representanteSelect">
        <option value="">Todos</option>
      </select>
    </div>

    <button class="btn-atualizar" onclick="carregar()">üîÅ Atualizar Dados</button>
  </div>

  <div id="dash"></div>

<script>
const client = libsql.createClient({
  url: "libsql://comercial-angeloxiru.aws-us-east-1.turso.io",
  authToken: "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NjI4ODQ2ODMsImlkIjoiMmI3NTFkOTQtNGI1ZS00ZjZhLWExMDktNTY0OTg3MzgyOGZhIiwicmlkIjoiOGZiZGQ3ZmMtOThmOC00MmMxLWExNzYtZmJiOTZhYmEwN2I0In0.ZjNIt9GEI01v_Ot9GnzsbS_FJIHjTVjCL9X8TdUJmi0LUfoMXX6xMJlRqNCRZiS6U3iNwkP709K_H8ybU9e3DQ"
});

let todosRepresentantes = [];

// Inicializa os filtros
async function inicializarFiltros() {
  try {
    // Carrega semanas
    await carregarSemanas();

    // Carrega supervisores e representantes
    await carregarSupervisoresERepresentantes();

  } catch (error) {
    console.error('Erro ao inicializar filtros:', error);
    alert('Erro ao carregar filtros: ' + error.message);
  }
}

// Preenche o seletor de semanas
async function carregarSemanas() {
  try {
    // Tenta buscar com ano_semana primeiro
    let result = await client.execute('SELECT DISTINCT ano_semana FROM potencial_representante ORDER BY ano_semana DESC');

    const select = document.getElementById('semanaSelect');
    select.innerHTML = '';

    if (result.rows.length === 0) {
      select.innerHTML = '<option value="">Nenhuma semana dispon√≠vel</option>';
      return;
    }

    result.rows.forEach(row => {
      const option = document.createElement('option');
      option.value = row.ano_semana;
      option.textContent = `Semana ${row.ano_semana}`;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Erro ao carregar semanas:', error);
    document.getElementById('semanaSelect').innerHTML = '<option value="">Erro ao carregar</option>';
  }
}

// Carrega supervisores e representantes
async function carregarSupervisoresERepresentantes() {
  try {
    // Busca dados da view
    const result = await client.execute('SELECT DISTINCT supervisor, representante FROM vw_performance_cobranca ORDER BY supervisor, representante');

    todosRepresentantes = result.rows;

    // Preenche supervisores
    const supervisores = [...new Set(result.rows.map(r => r.supervisor))].filter(s => s);
    const selectSupervisor = document.getElementById('supervisorSelect');
    selectSupervisor.innerHTML = '<option value="">Todos</option>';

    supervisores.forEach(sup => {
      const option = document.createElement('option');
      option.value = sup;
      option.textContent = sup;
      selectSupervisor.appendChild(option);
    });

    // Preenche todos representantes inicialmente
    preencherRepresentantes();

  } catch (error) {
    console.error('Erro ao carregar supervisores:', error);
  }
}

// Preenche select de representantes (filtrado por supervisor)
function preencherRepresentantes(supervisorFiltro = null) {
  const selectRep = document.getElementById('representanteSelect');
  selectRep.innerHTML = '<option value="">Todos</option>';

  let representantesFiltrados = todosRepresentantes;

  if (supervisorFiltro) {
    representantesFiltrados = todosRepresentantes.filter(r => r.supervisor === supervisorFiltro);
  }

  const representantesUnicos = [...new Set(representantesFiltrados.map(r => r.representante))].filter(r => r);

  representantesUnicos.forEach(rep => {
    const option = document.createElement('option');
    option.value = rep;
    option.textContent = rep;
    selectRep.appendChild(option);
  });
}

// Cascata: quando mudar supervisor, filtrar representantes
function filtrarRepresentantes() {
  const supervisorSelecionado = document.getElementById('supervisorSelect').value;
  preencherRepresentantes(supervisorSelecionado || null);
}

async function carregar() {
  const semanaSelecionada = document.getElementById('semanaSelect').value;
  const supervisorSelecionado = document.getElementById('supervisorSelect').value;
  const representanteSelecionado = document.getElementById('representanteSelect').value;

  if (!semanaSelecionada) {
    document.getElementById('dash').innerHTML = '<p style="color: red; text-align: center;">Selecione uma semana!</p>';
    return;
  }

  try {
    // Monta a query com filtros
    let sql = `SELECT * FROM vw_performance_cobranca WHERE ano_semana = ?`;
    const params = [semanaSelecionada];

    if (supervisorSelecionado) {
      sql += ' AND supervisor = ?';
      params.push(supervisorSelecionado);
    }

    if (representanteSelecionado) {
      sql += ' AND representante = ?';
      params.push(representanteSelecionado);
    }

    sql += ' ORDER BY perc_peso ASC';

    const result = await client.execute({
      sql: sql,
      args: params
    });

    const dash = document.getElementById('dash');

    if (result.rows.length === 0) {
      dash.innerHTML = `<p style="text-align: center; padding: 20px; color: #666;">
        <strong>Nenhum dado encontrado para os filtros selecionados.</strong><br>
        Verifique se:<br>
        ‚Ä¢ As metas est√£o cadastradas na tabela potencial_representante<br>
        ‚Ä¢ Existem vendas para essa semana<br>
        ‚Ä¢ O relacionamento representante-cidade est√° correto<br>
        ‚Ä¢ Os filtros est√£o corretos
      </p>`;
      return;
    }

    dash.innerHTML = '';

    result.rows.forEach(row => {
      let status = 'excelente';
      let prioridade = 'üü¢';
      if (row.perc_peso < 70 || row.perc_clientes < 70) {
        status = 'critico';
        prioridade = 'üî¥';
      } else if (row.perc_peso < 85 || row.perc_clientes < 85) {
        status = 'atencao';
        prioridade = 'üü°';
      }

      const html = `
        <div class="card ${status}">
          <div class="header">
            <h3>${row.representante} - ${row.cidade} ${prioridade}</h3>
            <p>Supervisor: ${row.supervisor} | Popula√ß√£o: ${parseInt(row.populacao || 0).toLocaleString('pt-BR')} hab.</p>
          </div>

          <div class="metrica">
            <div class="valor">${parseFloat(row.perc_peso || 0).toFixed(1)}%</div>
            <div class="label">Peso: ${parseFloat(row.peso_vendido || 0).toLocaleString('pt-BR')}kg / ${parseFloat(row.meta_peso || 0).toLocaleString('pt-BR')}kg</div>
            <div class="barra"><div class="barra-preenchida" style="width: ${Math.min(row.perc_peso || 0, 100)}%"></div></div>
          </div>

          <div class="metrica">
            <div class="valor">${parseFloat(row.perc_clientes || 0).toFixed(1)}%</div>
            <div class="label">Clientes: ${row.clientes_positivados || 0}/${row.meta_clientes || 0}</div>
            <div class="barra"><div class="barra-preenchida" style="width: ${Math.min(row.perc_clientes || 0, 100)}%"></div></div>
          </div>

          <div class="metrica">
            <div class="valor">R$ ${parseFloat(row.faturamento || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
            <div class="label">Faturamento Semanal</div>
          </div>

          <div class="metrica">
            <div class="valor">${parseFloat(row.penetracao_clientes_pct || 0).toFixed(1)}%</div>
            <div class="label">Penetra√ß√£o (Potencial: ${Math.floor((row.populacao || 0)/1000)} clientes)</div>
          </div>

          <div class="metrica">
            <div class="valor">${parseFloat(row.perc_desconto_medio || 0).toFixed(1)}%</div>
            <div class="label">Desconto M√©dio</div>
          </div>
        </div>
      `;
      dash.innerHTML += html;
    });
  } catch (error) {
    console.error('Erro ao carregar dados:', error);
    document.getElementById('dash').innerHTML = `<p style="color: red; text-align: center;">
      <strong>Erro ao carregar dados:</strong><br>
      ${error.message}
    </p>`;
  }
}

// Inicializa a p√°gina
inicializarFiltros();
</script>
</body>
</html>
