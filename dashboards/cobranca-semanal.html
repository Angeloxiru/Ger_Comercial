<!DOCTYPE html>
<html>
<head>
  <title>Cobran칞a Semanal | Ger.Comercial</title>
  <script src="https://cdn.jsdelivr.net/npm/@libsql/client@0.5.6/lib-cdn.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; margin: 20px; background: #f5f5f5; }
    .card { background: white; border-left: 5px solid #333; padding: 15px; margin: 10px 0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .critico { border-left-color: #d32f2f; background: #ffebee; }
    .atencao { border-left-color: #f57c00; background: #fff3e0; }
    .excelente { border-left-color: #388e3c; background: #e8f5e8; }
    .metrica { display: inline-block; width: 220px; margin: 5px; vertical-align: top; }
    .barra { height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; }
    .barra-preenchida { height: 100%; background: #4caf50; transition: width 0.3s; }
    .valor { font-size: 24px; font-weight: bold; color: #333; }
    .label { font-size: 12px; color: #666; }
    .header { background: #1976d2; color: white; padding: 10px; border-radius: 4px; }
    select { padding: 8px; font-size: 16px; margin: 10px 0; }
  </style>
</head>
<body>
  <h1>游꿢 Dashboard de Cobran칞a Semanal</h1>
  
  <!-- SELETOR DE SEMANA -->
  <div style="background: #e3f2fd; padding: 15px; border-radius: 4px; margin: 10px 0;">
    <label for="semanaSelect"><strong>Selecione a Semana:</strong></label>
    <select id="semanaSelect" onchange="carregar()">
      <option value="">-- Carregando semanas dispon칤veis --</option>
    </select>
    <button onclick="carregar()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">游대 Atualizar</button>
  </div>
  
  <div id="dash"></div>

<script>
const client = libsql.createClient({
  url: "libsql://seu-banco.turso.io",
  authToken: "seu-token-aqui"
});

// Preenche o seletor de semanas ao carregar a p치gina
async function carregarSemanas() {
  const result = await client.execute('SELECT DISTINCT ano_semana FROM potencial_representante ORDER BY ano_semana DESC');
  const select = document.getElementById('semanaSelect');
  select.innerHTML = '';
  
  result.rows.forEach(row => {
    const option = document.createElement('option');
    option.value = row.ano_semana;
    option.textContent = `Semana ${row.ano_semana}`;
    select.appendChild(option);
  });
  
  // Seleciona a semana atual por padr칚o
  const hoje = new Date();
  const semanaAtual = `${hoje.getFullYear()}-${String(Math.ceil((hoje - new Date(hoje.getFullYear(),0,1)) / 604800000)).padStart(2,'0')}`;
  select.value = semanaAtual;
}

async function carregar() {
  const semanaSelecionada = document.getElementById('semanaSelect').value;
  
  if (!semanaSelecionada) {
    document.getElementById('dash').innerHTML = '<p style="color: red;">Selecione uma semana!</p>';
    return;
  }
  
  const result = await client.execute(`
    SELECT * FROM vw_performance_cobranca 
    WHERE ano_semana = '${semanaSelecionada}'
    ORDER BY perc_peso ASC
  `);
  
  const dash = document.getElementById('dash');
  
  if (result.rows.length === 0) {
    dash.innerHTML = `<p style="text-align: center; padding: 20px; color: #666;">
      Nenhum dado encontrado para a semana ${semanaSelecionada}. 
      Verifique se as metas e vendas est칚o cadastradas.
    </p>`;
    return;
  }
  
  dash.innerHTML = '';
  
  result.rows.forEach(row => {
    let status = 'excelente';
    let prioridade = '游릭';
    if (row.perc_peso < 70 || row.perc_clientes < 70) { 
      status = 'critico'; 
      prioridade = '游댮';
    } else if (row.perc_peso < 85 || row.perc_clientes < 85) { 
      status = 'atencao'; 
      prioridade = '游리';
    }
    
    const html = `
      <div class="card ${status}">
        <div class="header">
          <h3>${row.representante} - ${row.cidade} ${prioridade}</h3>
          <p>Supervisor: ${row.supervisor} | Popula칞칚o: ${parseInt(row.populacao).toLocaleString('pt-BR')} hab.</p>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.perc_peso}%</div>
          <div class="label">Peso: ${parseFloat(row.peso_vendido).toLocaleString('pt-BR')}kg / ${parseFloat(row.meta_peso).toLocaleString('pt-BR')}kg</div>
          <div class="barra"><div class="barra-preenchida" style="width: ${row.perc_peso}%"></div></div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.perc_clientes}%</div>
          <div class="label">Clientes: ${row.clientes_positivados}/${row.meta_clientes}</div>
          <div class="barra"><div class="barra-preenchida" style="width: ${row.perc_clientes}%"></div></div>
        </div>
        
        <div class="metrica">
          <div class="valor">R$ ${parseFloat(row.faturamento).toLocaleString('pt-BR')}</div>
          <div class="label">Faturamento</div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.penetracao_clientes_pct}%</div>
          <div class="label">Penetra칞칚o (Potencial: ${Math.floor(row.populacao/1000)} clientes)</div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.perc_desconto_medio}%</div>
          <div class="label">Desconto M칠dio</div>
        </div>
      </div>
    `;
    dash.innerHTML += html;
  });
}

// Carrega as semanas dispon칤veis ao abrir a p치gina
carregarSemanas().then(() => carregar());
</script>
</body>
</html>
