<!DOCTYPE html>
<html>
<head>
  <title>DEBUG - Cobran√ßa Semanal</title>
  <script src="https://cdn.jsdelivr.net/npm/@libsql/client@0.5.6/lib-cdn.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #debug { background: #ffebee; border: 2px solid #d32f2f; padding: 15px; margin: 10px 0; border-radius: 4px; }
    #debug h3 { color: #d32f2f; }
    .success { background: #e8f5e8; border-color: #388e3c; }
    .success h3 { color: #388e3c; }
  </style>
</head>
<body>
  <h1>üêõ DEBUG - Dashboard de Cobran√ßa</h1>
  
  <div id="debug"></div>
  
  <div id="conteudo" style="display: none;">
    <p><strong>Semana Selecionada:</strong> <span id="semanaSelecionada"></span></p>
    <button onclick="carregarDados()">Atualizar Dados</button>
    <div id="dash"></div>
  </div>

<script>
const CONFIG = {
  url: "libsql://seu-banco.turso.io",
  authToken: "seu-token-aqui"
};

const debug = document.getElementById('debug');
const conteudo = document.getElementById('conteudo');

// Fun√ß√£o para mostrar mensagens de debug
function logDebug(mensagem, tipo = 'erro') {
  const div = document.createElement('div');
  div.innerHTML = `<h3>üîç ${tipo.toUpperCase()}:</h3><pre>${mensagem}</pre>`;
  div.className = tipo === 'sucesso' ? 'success' : '';
  debug.appendChild(div);
}

// Passo 1: Testar conex√£o
async function testarConexao() {
  logDebug('Testando conex√£o com Turso...');
  logDebug(`URL: ${CONFIG.url}`);
  logDebug(`Token: ${CONFIG.authToken.substring(0, 10)}...`);
  
  try {
    const client = libsql.createClient(CONFIG);
    const result = await client.execute('SELECT 1 as teste');
    logDebug(`‚úÖ Conex√£o OK: ${JSON.stringify(result.rows)}`, 'sucesso');
    return true;
  } catch (erro) {
    logDebug(`‚ùå ERRO NA CONEX√ÉO: ${erro.message}`);
    return false;
  }
}

// Passo 2: Testar query de semanas
async function testarQuerySemanas() {
  logDebug('\n--- Testando query de semanas ---');
  logDebug('SQL: SELECT DISTINCT ano_semana FROM potencial_representante ORDER BY ano_semana DESC');
  
  try {
    const client = libsql.createClient(CONFIG);
    const result = await client.execute('SELECT DISTINCT ano_semana FROM potencial_representante ORDER BY ano_semana DESC');
    logDebug(`‚úÖ Query OK: ${result.rows.length} semanas encontradas`, 'sucesso');
    logDebug(`Dados: ${JSON.stringify(result.rows)}`);
    return result.rows;
  } catch (erro) {
    logDebug(`‚ùå ERRO NA QUERY: ${erro.message}`);
    return null;
  }
}

// Passo 3: Testar view completa
async function testarViewCompleta() {
  logDebug('\n--- Testando view completa ---');
  logDebug('SQL: SELECT * FROM vw_performance_cobranca WHERE ano_semana = \'2025-40\' LIMIT 5');
  
  try {
    const client = libsql.createClient(CONFIG);
    const result = await client.execute("SELECT * FROM vw_performance_cobranca WHERE ano_semana = '2025-40' LIMIT 5");
    logDebug(`‚úÖ View OK: ${result.rows.length} registros`, 'sucesso');
    logDebug(`Dados: ${JSON.stringify(result.rows)}`);
    return result.rows;
  } catch (erro) {
    logDebug(`‚ùå ERRO NA VIEW: ${erro.message}`);
    return null;
  }
}

// Inicializa√ß√£o completa
async function inicializar() {
  debug.innerHTML = '<h2>üîç Iniciando Debug...</h2>';
  
  const conexaoOK = await testarConexao();
  if (!conexaoOK) return;
  
  const semanas = await testarQuerySemanas();
  if (!semanas) return;
  
  const dados = await testarViewCompleta();
  
  if (semanas && dados) {
    logDebug('\nüéâ TODOS OS TESTES PASSARAM!', 'sucesso');
    logDebug('O problema est√° no c√≥digo original. Use a pr√≥xima vers√£o.', 'sucesso');
    // Aqui voc√™ pode chamar o c√≥digo real
  }
}

// Execute ao carregar a p√°gina
inicializar();
</script>
</body>
</html>
