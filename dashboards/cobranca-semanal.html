<!DOCTYPE html>
<html>
<head>
  <title>Cobran√ßa Semanal | Ger.Comercial</title>
  <script src="https://cdn.jsdelivr.net/npm/@libsql/client@0.5.6/lib-cdn.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', Arial; margin: 20px; background: #f5f5f5; }
    .card { background: white; border-left: 5px solid #333; padding: 15px; margin: 10px 0; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .critico { border-left-color: #d32f2f; background: #ffebee; }
    .atencao { border-left-color: #f57c00; background: #fff3e0; }
    .excelente { border-left-color: #388e3c; background: #e8f5e8; }
    .metrica { display: inline-block; width: 220px; margin: 5px; vertical-align: top; }
    .barra { height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; }
    .barra-preenchida { height: 100%; background: #4caf50; transition: width 0.3s; }
    .valor { font-size: 24px; font-weight: bold; color: #333; }
    .label { font-size: 12px; color: #666; }
    .header { background: #1976d2; color: white; padding: 10px; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>üéØ Dashboard de Cobran√ßa Semanal</h1>
  <p>Per√≠odo: <strong id="periodo"></strong> | 
     Semana: <strong id="semanaAtual"></strong> | 
     <button onclick="carregar()" style="padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">üîÅ Atualizar Dados</button>
  </p>
  
  <div id="dash"></div>

<script>
const client = libsql.createClient({
  url: "libsql://comercial-angeloxiru.aws-us-east-1.turso.io",
  authToken: "eyJhbGciOiJFZERTQSIsInR5cCI6IkpXVCJ9.eyJhIjoicnciLCJpYXQiOjE3NjI4ODQ2ODMsImlkIjoiMmI3NTFkOTQtNGI1ZS00ZjZhLWExMDktNTY0OTg3MzgyOGZhIiwicmlkIjoiOGZiZGQ3ZmMtOThmOC00MmMxLWExNzYtZmJiOTZhYmEwN2I0In0.ZjNIt9GEI01v_Ot9GnzsbS_FJIHjTVjCL9X8TdUJmi0LUfoMXX6xMJlRqNCRZiS6U3iNwkP709K_H8ybU9e3DQi"
});

async function carregar() {
  // Define per√≠odo (√∫ltimos 7 dias)
  const hoje = new Date();
  const seteDiasAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
  document.getElementById('periodo').textContent = 
    seteDiasAtras.toLocaleDateString('pt-BR') + ' a ' + hoje.toLocaleDateString('pt-BR');
  
  // Calcula semana atual
  const inicioAno = new Date(hoje.getFullYear(), 0, 1);
  const semana = Math.ceil((Math.floor((hoje - inicioAno) / 86400000) + inicioAno.getDay() + 1) / 7);
  document.getElementById('semanaAtual').textContent = `${hoje.getFullYear()}-${semana.toString().padStart(2, '0')}`;
  
  const result = await client.execute('SELECT * FROM vw_performance_cobranca ORDER BY perc_peso ASC');
  const dash = document.getElementById('dash');
  dash.innerHTML = '';
  
  result.rows.forEach(row => {
    // Define status pela pior m√©trica
    let status = 'excelente';
    let prioridade = 'üü¢';
    if (row.perc_peso < 70 || row.perc_clientes < 70) { 
      status = 'critico'; 
      prioridade = 'üî¥ URGENTE';
    } else if (row.perc_peso < 85 || row.perc_clientes < 85) { 
      status = 'atencao'; 
      prioridade = 'üü° A√ß√£o';
    }
    
    const html = `
      <div class="card ${status}">
        <div class="header">
          <h3>${row.representante} - ${row.cidade} ${prioridade}</h3>
          <p>Supervisor: ${row.supervisor} | Popula√ß√£o: ${parseInt(row.populacao).toLocaleString('pt-BR')} hab.</p>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.perc_peso}%</div>
          <div class="label">Peso: ${parseFloat(row.peso_vendido).toLocaleString('pt-BR')}kg / ${parseFloat(row.meta_peso).toLocaleString('pt-BR')}kg</div>
          <div class="barra"><div class="barra-preenchida" style="width: ${row.perc_peso}%"></div></div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.perc_clientes}%</div>
          <div class="label">Clientes: ${row.clientes_positivados}/${row.meta_clientes}</div>
          <div class="barra"><div class="barra-preenchida" style="width: ${row.perc_clientes}%"></div></div>
        </div>
        
        <div class="metrica">
          <div class="valor">R$ ${parseFloat(row.faturamento).toLocaleString('pt-BR')}</div>
          <div class="label">Faturamento Semanal</div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.penetracao_clientes_pct}%</div>
          <div class="label">Penetra√ß√£o (Potencial: ${Math.floor(row.populacao/1000)} clientes)</div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.clientes_novos}</div>
          <div class="label">Clientes Novos</div>
        </div>
        
        <div class="metrica">
          <div class="valor">${row.perc_desconto_medio}%</div>
          <div class="label">Desconto M√©dio</div>
        </div>
      </div>
    `;
    dash.innerHTML += html;
  });
}

carregar();
</script>
</body>
</html>
