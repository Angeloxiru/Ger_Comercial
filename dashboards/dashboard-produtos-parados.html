<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Dashboard de Produtos Parados - Ger Comercial">
    <meta name="theme-color" content="#fc0303">
    <title>Produtos Parados - Ger Comercial</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="/Ger_Comercial/manifest.json">
    <link rel="apple-touch-icon" href="/Ger_Comercial/icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/Ger_Comercial/icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .header {
            background: #fc0303;
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-logo img {
            height: 60px;
            width: auto;
        }

        .header h1 {
            font-size: 1.6em;
            font-weight: 600;
        }

        .btn-voltar {
            background: white;
            color: #fc0303;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
        }

        .btn-voltar:hover {
            background: #f8f9fa;
        }

        .filters-section {
            background: white;
            padding: 16px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .filters-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .filters-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 160px;
        }

        .btn-limpar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-limpar:hover {
            background: #5a6268;
        }

        .filter-group label {
            color: #495057;
            font-weight: 500;
            margin-bottom: 6px;
            font-size: 0.9em;
            display: block;
        }

        .filter-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
            background: white;
            cursor: pointer;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #fc0303;
            box-shadow: 0 0 0 3px rgba(252, 3, 3, 0.1);
        }

        .btn-atualizar {
            background: #fc0303;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-atualizar:hover {
            background: #b50909;
        }

        .btn-atualizar:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-whatsapp {
            background: #25D366;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-whatsapp:hover {
            background: #1da851;
        }

        .btn-whatsapp:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-export {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn-export:hover {
            background: #c82333;
        }

        .btn-export:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .main-content {
            display: grid;
            grid-template-columns: 70% 30%;
            gap: 20px;
            margin: 0 20px 20px 20px;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            color: #212529;
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #fc0303;
        }

        .kpi-label {
            color: #6c757d;
            font-size: 0.85em;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 500;
        }

        .kpi-value {
            color: #212529;
            font-size: 2em;
            font-weight: 700;
        }

        .kpi-change {
            font-size: 0.85em;
            margin-top: 8px;
        }

        .kpi-change.positive {
            color: #28a745;
        }

        .kpi-change.negative {
            color: #dc3545;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        thead {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        th {
            text-align: left;
            padding: 12px;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f1f3f5;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .badge-extremo {
            background: #8b0000;
            color: white;
        }

        .badge-muito-alto {
            background: #dc3545;
            color: white;
        }

        .badge-alto {
            background: #fd7e14;
            color: white;
        }

        .badge-moderado {
            background: #ffc107;
            color: #000;
        }

        .badge-baixo {
            background: #28a745;
            color: white;
        }

        .badge-minimo {
            background: #20c997;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading.show {
            display: block;
        }

        .empty-state {
            display: none;
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state.show {
            display: block;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .kpis-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .filters-buttons {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <div class="header-logo">
                <img src="https://static.wixstatic.com/media/ce3165_c01db19c0ef64e2abb8c894c7ecc6f95~mv2.png/v1/fill/w_161,h_69,al_c,q_85,usm_0.66_1.00_0.01,enc_avif,quality_auto/logomarca-Germani-2023-Branca-borda-dour.png" alt="Logo Germani Alimentos">
            </div>
            <h1>üõë Produtos Parados</h1>
        </div>
        <a href=".." class="btn-voltar">‚Üê Voltar</a>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
        <div class="filters-grid">
            <div class="filter-group">
                <label for="filterSupervisor">Supervisor</label>
                <select id="filterSupervisor" onchange="aplicarFiltros()">
                    <option value="">Todos os Supervisores</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filterRepresentante">Representante</label>
                <select id="filterRepresentante" onchange="aplicarFiltros()">
                    <option value="">Todos os Representantes</option>
                </select>
            </div>

            <div class="filter-group">
                <label for="filterRisco">N√≠vel de Risco</label>
                <select id="filterRisco" onchange="aplicarFiltros()">
                    <option value="">Todos os N√≠veis</option>
                    <option value="EXTREMO">‚ö´ Extremo (6+ sem)</option>
                    <option value="MUITO ALTO">üî¥ Muito Alto (5 sem)</option>
                    <option value="ALTO">üü† Alto (4 sem)</option>
                    <option value="MODERADO">üü° Moderado (3 sem)</option>
                    <option value="BAIXO">üü¢ Baixo (2 sem)</option>
                    <option value="M√çNIMO">üîµ M√≠nimo (1 sem)</option>
                </select>
            </div>
        </div>

        <div class="filters-buttons">
            <button class="btn-limpar" onclick="limparFiltros()">üßπ Limpar</button>
            <button class="btn-atualizar" onclick="carregarDados()" id="btnAtualizar">üîÑ Atualizar</button>
            <button class="btn-export" onclick="exportarPDF()" id="btnPDF" style="display: none;">üìÑ PDF</button>
            <button class="btn-whatsapp" onclick="enviarWhatsApp()" id="btnWhatsApp" style="display: none;">üì± WhatsApp</button>
        </div>
    </div>

    <!-- KPIs -->
    <div class="kpis-grid" style="margin: 0 20px;">
        <div class="kpi-card">
            <div class="kpi-label">Total de Produtos Parados</div>
            <div class="kpi-value" id="kpiTotalProdutos">-</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Valor Total em Risco</div>
            <div class="kpi-value" id="kpiValorRisco">-</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">Representantes Afetados</div>
            <div class="kpi-value" id="kpiRepresentantes">-</div>
        </div>

        <div class="kpi-card">
            <div class="kpi-label">M√©dia de Semanas Parado</div>
            <div class="kpi-value" id="kpiMediaSemanas">-</div>
        </div>
    </div>

    <!-- Conte√∫do Principal -->
    <div class="main-content">
        <!-- Painel Esquerdo: Tabela -->
        <div class="left-panel">
            <div class="card">
                <div class="card-title">üìã Lista de Produtos Parados</div>

                <div class="loading" id="loadingTable">
                    ‚è≥ Carregando dados...
                </div>

                <div class="empty-state" id="emptyTable">
                    <div class="empty-state-icon">‚úÖ</div>
                    <h3>Nenhum produto parado encontrado</h3>
                    <p>√ìtima not√≠cia! N√£o h√° produtos que pararam de ser vendidos no per√≠odo analisado.</p>
                </div>

                <div class="table-container" id="tableContainer" style="display: none;">
                    <table id="tableData">
                        <thead>
                            <tr>
                                <th>Risco</th>
                                <th>Supervisor</th>
                                <th>Representante</th>
                                <th>Produto</th>
                                <th>√öltima Venda</th>
                                <th>Semanas Parado</th>
                                <th>Valor M√©dio</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Painel Direito: Gr√°ficos e Resumo -->
        <div class="right-panel">
            <div class="card">
                <div class="card-title">üî• Top 10 Produtos Mais Paralisados</div>
                <div class="chart-container">
                    <canvas id="chartTopProdutos"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìä Distribui√ß√£o por Risco</div>
                <div class="chart-container">
                    <canvas id="chartRisco"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../js/db.js';
        import { cache, CACHE_TTL } from '../js/cache.js';
        import { FilterSearch, injectFilterSearchStyles } from '../js/filter-search.js';

        // Injetar estilos do FilterSearch
        injectFilterSearchStyles();

        // Estado global
        let dadosCompletos = [];
        let dadosFiltrados = [];
        let chartTopProdutos = null;
        let chartRisco = null;
        let filterSearchInstances = {};

        // Carregar dados
        async function carregarDados() {
            try {
                mostrarLoading(true);

                // Conectar ao banco
                await db.connect();

                // Buscar dados da view
                const result = await db.execute(`
                    SELECT * FROM vw_produtos_parados
                    ORDER BY qtd_semanas_parado DESC, valor_medio_perdido DESC
                `);

                dadosCompletos = result.rows || [];
                dadosFiltrados = [...dadosCompletos];

                console.log('‚úÖ Dados carregados:', dadosCompletos.length, 'produtos parados');

                // Atualizar interface
                popularFiltros();
                aplicarFiltros();
                mostrarLoading(false);

            } catch (error) {
                console.error('‚ùå Erro ao carregar dados:', error);
                alert('Erro ao carregar dados. Verifique o console para mais detalhes.');
                mostrarLoading(false);
            }
        }

        // Popular filtros
        function popularFiltros() {
            // Supervisores √∫nicos
            const supervisores = [...new Set(dadosCompletos.map(d => d.rep_supervisor).filter(s => s))].sort();
            const selectSupervisor = document.getElementById('filterSupervisor');

            // Representantes √∫nicos
            const representantes = [...new Set(dadosCompletos.map(d => d.desc_representante).filter(r => r))].sort();
            const selectRepresentante = document.getElementById('filterRepresentante');

            // Destruir inst√¢ncias anteriores do FilterSearch para recriar com dados novos
            if (filterSearchInstances.filterSupervisor) {
                filterSearchInstances.filterSupervisor.destroy();
                filterSearchInstances.filterSupervisor = null;
            }
            if (filterSearchInstances.filterRepresentante) {
                filterSearchInstances.filterRepresentante.destroy();
                filterSearchInstances.filterRepresentante = null;
            }

            // Limpar e popular supervisores
            selectSupervisor.innerHTML = '';
            const optSupervisorDefault = document.createElement('option');
            optSupervisorDefault.value = '';
            optSupervisorDefault.textContent = 'Todos os Supervisores';
            selectSupervisor.appendChild(optSupervisorDefault);

            supervisores.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s;
                selectSupervisor.appendChild(opt);
            });

            // Limpar e popular representantes
            selectRepresentante.innerHTML = '';
            const optRepresentanteDefault = document.createElement('option');
            optRepresentanteDefault.value = '';
            optRepresentanteDefault.textContent = 'Todos os Representantes';
            selectRepresentante.appendChild(optRepresentanteDefault);

            representantes.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r;
                opt.textContent = r;
                selectRepresentante.appendChild(opt);
            });

            // Criar novas inst√¢ncias do FilterSearch DEPOIS de popular as op√ß√µes
            filterSearchInstances.filterSupervisor = new FilterSearch('filterSupervisor', {
                placeholder: 'Digite para buscar supervisor...'
            });

            filterSearchInstances.filterRepresentante = new FilterSearch('filterRepresentante', {
                placeholder: 'Digite para buscar representante...'
            });
        }

        // Aplicar filtros
        function aplicarFiltros() {
            const supervisor = document.getElementById('filterSupervisor').value;
            const representante = document.getElementById('filterRepresentante').value;
            const risco = document.getElementById('filterRisco').value;

            dadosFiltrados = dadosCompletos.filter(item => {
                if (supervisor && item.rep_supervisor !== supervisor) return false;
                if (representante && item.desc_representante !== representante) return false;
                if (risco && item.nivel_risco !== risco) return false;
                return true;
            });

            atualizarInterface();
        }

        // Atualizar interface
        function atualizarInterface() {
            atualizarKPIs();
            atualizarTabela();
            atualizarGraficos();

            const btnWhatsApp = document.getElementById('btnWhatsApp');
            const btnPDF = document.getElementById('btnPDF');

            // Mostrar/ocultar empty state e bot√µes de exporta√ß√£o
            if (dadosFiltrados.length === 0) {
                document.getElementById('emptyTable').classList.add('show');
                document.getElementById('tableContainer').style.display = 'none';
                btnWhatsApp.style.display = 'none';
                btnPDF.style.display = 'none';
            } else {
                document.getElementById('emptyTable').classList.remove('show');
                document.getElementById('tableContainer').style.display = 'block';
                btnWhatsApp.style.display = 'block';
                btnPDF.style.display = 'block';
            }
        }

        // Atualizar KPIs
        function atualizarKPIs() {
            const totalProdutos = dadosFiltrados.length;
            const valorTotal = dadosFiltrados.reduce((sum, item) => sum + (item.valor_medio_perdido || 0), 0);
            const representantesUnicos = new Set(dadosFiltrados.map(d => d.desc_representante)).size;
            const mediaSemanas = dadosFiltrados.length > 0
                ? (dadosFiltrados.reduce((sum, item) => sum + (item.qtd_semanas_parado || 0), 0) / dadosFiltrados.length).toFixed(1)
                : 0;

            document.getElementById('kpiTotalProdutos').textContent = totalProdutos.toLocaleString('pt-BR');
            document.getElementById('kpiValorRisco').textContent = 'R$ ' + valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2});
            document.getElementById('kpiRepresentantes').textContent = representantesUnicos;
            document.getElementById('kpiMediaSemanas').textContent = mediaSemanas + ' sem';
        }

        // Atualizar tabela
        function atualizarTabela() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            dadosFiltrados.forEach(item => {
                const tr = document.createElement('tr');

                const badgeClass = {
                    'EXTREMO': 'badge-extremo',
                    'MUITO ALTO': 'badge-muito-alto',
                    'ALTO': 'badge-alto',
                    'MODERADO': 'badge-moderado',
                    'BAIXO': 'badge-baixo',
                    'M√çNIMO': 'badge-minimo'
                }[item.nivel_risco] || 'badge-baixo';

                tr.innerHTML = `
                    <td><span class="badge ${badgeClass}">${item.nivel_risco}</span></td>
                    <td>${item.rep_supervisor || '-'}</td>
                    <td>${item.desc_representante || '-'}</td>
                    <td>${item.desc_produto || '-'}</td>
                    <td>${formatarData(item.ultima_venda)}</td>
                    <td>${item.qtd_semanas_parado} semanas</td>
                    <td>R$ ${(item.valor_medio_perdido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                `;

                tbody.appendChild(tr);
            });
        }

        // Atualizar gr√°ficos
        function atualizarGraficos() {
            atualizarGraficoTopProdutos();
            atualizarGraficoRisco();
        }

        // Gr√°fico Top 10 Produtos
        function atualizarGraficoTopProdutos() {
            // Agrupar por produto
            const produtosAgrupados = {};
            dadosFiltrados.forEach(item => {
                if (!produtosAgrupados[item.desc_produto]) {
                    produtosAgrupados[item.desc_produto] = {
                        produto: item.desc_produto,
                        qtdReps: 0,
                        valorTotal: 0
                    };
                }
                produtosAgrupados[item.desc_produto].qtdReps++;
                produtosAgrupados[item.desc_produto].valorTotal += (item.valor_medio_perdido || 0);
            });

            // Ordenar e pegar top 10
            const top10 = Object.values(produtosAgrupados)
                .sort((a, b) => b.qtdReps - a.qtdReps)
                .slice(0, 10);

            const ctx = document.getElementById('chartTopProdutos');
            if (chartTopProdutos) {
                chartTopProdutos.destroy();
            }

            chartTopProdutos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(p => p.produto.length > 50 ? p.produto.substring(0, 50) + '...' : p.produto),
                    datasets: [{
                        label: 'Representantes Afetados',
                        data: top10.map(p => p.qtdReps),
                        backgroundColor: '#fc0303',
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y', // Barras horizontais
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de Risco
        function atualizarGraficoRisco() {
            const riscos = {
                'EXTREMO': 0,
                'MUITO ALTO': 0,
                'ALTO': 0,
                'MODERADO': 0,
                'BAIXO': 0,
                'M√çNIMO': 0
            };

            dadosFiltrados.forEach(item => {
                if (riscos.hasOwnProperty(item.nivel_risco)) {
                    riscos[item.nivel_risco]++;
                }
            });

            const ctx = document.getElementById('chartRisco');
            if (chartRisco) {
                chartRisco.destroy();
            }

            chartRisco = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Extremo', 'Muito Alto', 'Alto', 'Moderado', 'Baixo', 'M√≠nimo'],
                    datasets: [{
                        data: [riscos.EXTREMO, riscos['MUITO ALTO'], riscos.ALTO, riscos.MODERADO, riscos.BAIXO, riscos.M√çNIMO],
                        backgroundColor: ['#8b0000', '#dc3545', '#fd7e14', '#ffc107', '#28a745', '#20c997']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Limpar filtros
        function limparFiltros() {
            document.getElementById('filterSupervisor').value = '';
            document.getElementById('filterRepresentante').value = '';
            document.getElementById('filterRisco').value = '';

            // Limpar campos de busca do FilterSearch
            if (filterSearchInstances.filterSupervisor) {
                filterSearchInstances.filterSupervisor.clear();
            }
            if (filterSearchInstances.filterRepresentante) {
                filterSearchInstances.filterRepresentante.clear();
            }

            aplicarFiltros();
        }

        // Mostrar/ocultar loading
        function mostrarLoading(show) {
            document.getElementById('loadingTable').classList.toggle('show', show);
            document.getElementById('btnAtualizar').disabled = show;
        }

        // Formatar data
        function formatarData(data) {
            if (!data) return '-';
            try {
                return new Date(data).toLocaleDateString('pt-BR');
            } catch {
                return data;
            }
        }

        // Exportar PDF
        function exportarPDF() {
            if (dadosFiltrados.length === 0) {
                alert('N√£o h√° dados para exportar');
                return null;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('landscape');

                // Cabe√ßalho
                doc.setFontSize(18);
                doc.setTextColor(252, 3, 3);
                doc.text('Produtos Parados - Germani Alimentos', 14, 20);

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, 14, 28);
                doc.text(`Total de produtos: ${dadosFiltrados.length}`, 14, 34);

                // Preparar dados da tabela
                const tableData = dadosFiltrados.map(row => [
                    row.nivel_risco || '-',
                    row.rep_supervisor || '-',
                    row.desc_representante || '-',
                    row.desc_produto || '-',
                    formatarData(row.ultima_venda),
                    row.qtd_semanas_parado + ' sem',
                    'R$ ' + (row.valor_medio_perdido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})
                ]);

                doc.autoTable({
                    head: [['Risco', 'Supervisor', 'Representante', 'Produto', '√öltima Venda', 'Semanas', 'Valor M√©dio']],
                    body: tableData,
                    startY: 40,
                    theme: 'striped',
                    headStyles: {
                        fillColor: [252, 3, 3],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        fontSize: 9
                    },
                    bodyStyles: {
                        fontSize: 8
                    },
                    alternateRowStyles: {
                        fillColor: [248, 249, 250]
                    },
                    columnStyles: {
                        0: { cellWidth: 25 },
                        3: { cellWidth: 60 }
                    }
                });

                const dataAtual = new Date().toISOString().split('T')[0];
                const fileName = `produtos_parados_${dataAtual}.pdf`;
                doc.save(fileName);

                return fileName; // Retorna o nome do arquivo para uso no WhatsApp
            } catch (error) {
                console.error('Erro ao exportar PDF:', error);
                alert('Erro ao exportar PDF: ' + error.message);
                return null;
            }
        }

        // Enviar por WhatsApp (nova vers√£o din√¢mica)
        async function enviarWhatsApp() {
            if (dadosFiltrados.length === 0) {
                alert('N√£o h√° dados para enviar');
                return;
            }

            try {
                // Buscar telefone do representante se houver filtro aplicado
                let telefoneDestino = '';
                const representanteFiltrado = document.getElementById('filterRepresentante').value;

                if (representanteFiltrado) {
                    // Buscar telefone do representante no banco
                    const result = await db.execute(`
                        SELECT rep_fone
                        FROM tab_representante
                        WHERE desc_representante = ?
                        LIMIT 1
                    `, [representanteFiltrado]);

                    if (result.rows && result.rows.length > 0 && result.rows[0].rep_fone) {
                        // Limpar telefone (remover caracteres especiais)
                        telefoneDestino = result.rows[0].rep_fone.replace(/\D/g, '');

                        // Garantir c√≥digo do pa√≠s (Brasil)
                        if (telefoneDestino.length === 11 && !telefoneDestino.startsWith('55')) {
                            telefoneDestino = '55' + telefoneDestino;
                        }
                    }
                }

                // Preparar dados do relat√≥rio
                const totalProdutos = dadosFiltrados.length;
                const valorTotal = dadosFiltrados.reduce((sum, item) => sum + (item.valor_medio_perdido || 0), 0);

                // Agrupar por n√≠vel de risco
                const porRisco = {};
                dadosFiltrados.forEach(item => {
                    const risco = item.nivel_risco || 'INDEFINIDO';
                    porRisco[risco] = (porRisco[risco] || 0) + 1;
                });

                // Montar mensagem formatada em texto (sem emojis para evitar problemas de encoding)
                let mensagem = `*PRODUTOS PARADOS - Germani Alimentos*\n\n`;
                mensagem += `Data: ${new Date().toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric'})} - ${new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}\n\n`;

                mensagem += `*RESUMO GERAL*\n`;
                mensagem += `Total de produtos: *${totalProdutos}*\n`;
                mensagem += `Valor em risco: *R$ ${valorTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}*\n`;
                mensagem += `Representantes afetados: *${new Set(dadosFiltrados.map(d => d.desc_representante)).size}*\n\n`;

                mensagem += `*DISTRIBUICAO POR RISCO*\n`;
                const riscoSimbolos = {
                    'EXTREMO': '[EXTREMO]',
                    'MUITO ALTO': '[MUITO ALTO]',
                    'ALTO': '[ALTO]',
                    'MODERADO': '[MODERADO]',
                    'BAIXO': '[BAIXO]',
                    'MINIMO': '[MINIMO]'
                };

                Object.entries(porRisco).sort((a, b) => {
                    const ordem = ['EXTREMO', 'MUITO ALTO', 'ALTO', 'MODERADO', 'BAIXO', 'MINIMO'];
                    return ordem.indexOf(a[0]) - ordem.indexOf(b[0]);
                }).forEach(([risco, qtd]) => {
                    const simbolo = riscoSimbolos[risco] || '[?]';
                    mensagem += `${simbolo} ${risco}: *${qtd} produto${qtd > 1 ? 's' : ''}*\n`;
                });

                mensagem += `\n*TOP 5 PRODUTOS CRITICOS*\n`;
                const top5 = dadosFiltrados
                    .sort((a, b) => (b.valor_medio_perdido || 0) - (a.valor_medio_perdido || 0))
                    .slice(0, 5);

                top5.forEach((item, index) => {
                    const simbolo = riscoSimbolos[item.nivel_risco] || '[?]';
                    mensagem += `\n${index + 1}. ${simbolo} *${item.desc_produto || 'Produto'}*\n`;
                    mensagem += `   Rep: ${item.desc_representante || '-'}\n`;
                    mensagem += `   Parado: ${item.qtd_semanas_parado} semana${item.qtd_semanas_parado > 1 ? 's' : ''}\n`;
                    mensagem += `   Valor medio: R$ ${(item.valor_medio_perdido || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                });

                mensagem += `\n========================================\n`;
                mensagem += `*Acao recomendada:* Contatar clientes e reativar vendas\n`;
                mensagem += `Para relatorio completo em PDF, use o botao de exportacao no sistema.`;

                // Abrir WhatsApp
                const mensagemEncoded = encodeURIComponent(mensagem);
                let whatsappURL;

                if (telefoneDestino) {
                    whatsappURL = `https://wa.me/${telefoneDestino}?text=${mensagemEncoded}`;
                    console.log('üì± Enviando para:', telefoneDestino);
                } else {
                    whatsappURL = `https://wa.me/?text=${mensagemEncoded}`;
                    console.log('üì± Abrindo WhatsApp sem n√∫mero espec√≠fico');
                }

                window.open(whatsappURL, '_blank');

            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
                alert('Erro ao preparar envio: ' + error.message);
            }
        }

        // Tornar fun√ß√µes globais
        window.carregarDados = carregarDados;
        window.aplicarFiltros = aplicarFiltros;
        window.limparFiltros = limparFiltros;
        window.exportarPDF = exportarPDF;
        window.enviarWhatsApp = enviarWhatsApp;

        // Carregar dados ao iniciar
        carregarDados();
    </script>
</body>
</html>
